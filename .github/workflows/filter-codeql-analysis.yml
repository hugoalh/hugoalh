# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Filter CodeQL Analysis"
on:
  workflow_run:
    types:
      - "completed"
    workflows:
      - "Invoke CodeQL Analysis"
jobs:
  main:
    permissions:
      contents: "read"
      security-events: "write"
    runs-on: "ubuntu-latest"
    steps:
      - shell: "pwsh"
        env:
          CDV_GHAAT: "${{secrets.GITHUB_TOKEN}}"
        run: |-
          Invoke-RestMethod -Uri "https://api.github.com/repos/$($Env:GITHUB_REPOSITORY)/code-scanning/alerts?per_page=100&state=open" -Headers @{
            Accept = 'application/vnd.github+json';
            Authorization = "Bearer $($Env:CDV_GHAAT)";
            'X-GitHub-Api-Version' = '2022-11-28'
          } -Method 'Get' -FollowRelLink |
            Where-Object -FilterScript {
              $_.tool.name -eq 'CodeQL' -and $_.rule.id -eq 'actions/unpinned-tag'
            } |
            ForEach-Object -Process {
              Invoke-RestMethod -Uri "https://api.github.com/repos/$($Env:GITHUB_REPOSITORY)/code-scanning/alerts/$($_.number)" -Headers @{
                Accept = 'application/vnd.github+json';
                Authorization = "Bearer $($Env:CDV_GHAAT)";
                Content-Type = 'application/json';
                'X-GitHub-Api-Version' = '2022-11-28'
              } -Method 'Patch' -Body (
                ConvertTo-Json -InputObject @{
                  state = 'dismissed';
                  dismissed_reason = "won't fix";
                  create_request = $True
                } -Depth 100 -Compress
              )
            }
